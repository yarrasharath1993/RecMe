# Planner Loop Output Contract

**Generated**: January 25, 2026  
**Purpose**: Canonical JSON schema that ALL planner loops must emit (NO CODE)

---

## Contract Statement

Every ClawDBot planner loop **MUST** emit outputs in this exact JSON schema. This ensures determinism, diffability, and zero autonomy.

---

## Canonical Schema

### Schema Definition

```json
{
  "loop": "trend_scan",
  "timestamp": "2026-01-25T12:00:00Z",
  "confidence": 0.85,
  "signals": [],
  "ideas": [],
  "risks": [],
  "recommended_actions": [],
  "constraints": [
    "READ_ONLY",
    "NO_PUBLISH",
    "HUMAN_REVIEW_REQUIRED"
  ]
}
```

---

## Schema Fields

### loop (string, required)

#### Definition
Identifier of the planner loop that generated this output.

#### Valid Values
- `"trend_scan"` - Trend scanning loop
- `"opportunity_detection"` - Opportunity detection loop
- `"content_idea_planning"` - Content idea planning loop
- `"contradiction_detection"` - Contradiction detection loop
- `"daily_digest"` - Daily digest loop

#### Examples
```json
"loop": "trend_scan"
```

---

### timestamp (string, required)

#### Definition
ISO-8601 timestamp when this output was generated.

#### Format
- ISO-8601 format: `YYYY-MM-DDTHH:mm:ssZ`
- UTC timezone
- Millisecond precision optional

#### Examples
```json
"timestamp": "2026-01-25T12:00:00Z"
```

---

### confidence (number, required)

#### Definition
Overall confidence score for this loop output (0.0-1.0).

#### Valid Values
- `0.0` to `1.0` (inclusive)

#### Calculation
- Reference: `clawdbot/scoring/confidence_model.md`
- Components: Data quality (40%), Analysis quality (30%), Source consensus (20%), Historical accuracy (10%)

#### Examples
```json
"confidence": 0.85
```

#### Confidence Levels
- **â‰¥0.90**: High confidence (auto-approved if other criteria met)
- **0.75-0.89**: Medium confidence (standard approval required)
- **0.50-0.74**: Low confidence (enhanced approval required)
- **<0.50**: Very low confidence (executive approval required)

---

### signals (array, required)

#### Definition
Array of signals detected by this loop. Each signal is an object with type-specific fields.

#### Signal Types
- `trend_signal` - Trend detection signals
- `opportunity_signal` - Opportunity detection signals
- `contradiction_signal` - Contradiction detection signals
- `risk_signal` - Risk detection signals

#### Signal Format
```json
{
  "type": "trend_signal",
  "signal_id": "signal-123",
  "description": "Emerging trend detected",
  "confidence": 0.85,
  "priority": "high",
  "metadata": {}
}
```

#### Examples
```json
"signals": [
  {
    "type": "trend_signal",
    "signal_id": "trend-001",
    "description": "Action-comedy genre gaining popularity",
    "confidence": 0.85,
    "priority": "high",
    "metadata": {
      "trend_strength": 0.75,
      "trend_drivers": ["Recent hit movies", "Audience preference shift"]
    }
  }
]
```

---

### ideas (array, required)

#### Definition
Array of ideas generated by this loop. Each idea is an object with type-specific fields.

#### Idea Types
- `editorial_idea` - Editorial content ideas
- `content_idea` - Content ideas
- `improvement_idea` - Improvement ideas

#### Idea Format
```json
{
  "type": "editorial_idea",
  "idea_id": "idea-123",
  "title": "Idea title",
  "description": "Idea description",
  "confidence": 0.80,
  "priority": "medium",
  "metadata": {}
}
```

#### Examples
```json
"ideas": [
  {
    "type": "editorial_idea",
    "idea_id": "idea-001",
    "title": "Trend Analysis: Action-Comedy Genre",
    "description": "Write article about emerging action-comedy trend",
    "confidence": 0.80,
    "priority": "medium",
    "metadata": {
      "target_audience": "movie enthusiasts",
      "estimated_read_time": "5 minutes"
    }
  }
]
```

---

### risks (array, required)

#### Definition
Array of risks identified by this loop. Each risk is an object with type-specific fields.

#### Risk Types
- `data_risk` - Data quality risks
- `contradiction_risk` - Contradiction risks
- `cost_risk` - Cost escalation risks
- `execution_risk` - Execution risks

#### Risk Format
```json
{
  "type": "data_risk",
  "risk_id": "risk-123",
  "description": "Risk description",
  "severity": "high",
  "confidence": 0.75,
  "metadata": {}
}
```

#### Examples
```json
"risks": [
  {
    "type": "contradiction_risk",
    "risk_id": "risk-001",
    "description": "Conflicting trend signals detected",
    "severity": "medium",
    "confidence": 0.75,
    "metadata": {
      "contradiction_type": "trend_signal",
      "affected_signals": ["trend-001", "trend-002"]
    }
  }
]
```

---

### recommended_actions (array, required)

#### Definition
Array of recommended actions. Each action is an object with type-specific fields.

#### Action Types
- `review_action` - Actions requiring human review
- `investigation_action` - Actions requiring investigation
- `implementation_action` - Actions for implementation (after approval)

#### Action Format
```json
{
  "type": "review_action",
  "action_id": "action-123",
  "description": "Action description",
  "priority": "high",
  "confidence": 0.80,
  "metadata": {}
}
```

#### Examples
```json
"recommended_actions": [
  {
    "type": "review_action",
    "action_id": "action-001",
    "description": "Review emerging trend signal for action-comedy genre",
    "priority": "high",
    "confidence": 0.80,
    "metadata": {
      "related_signal": "trend-001",
      "review_deadline": "2026-01-26T12:00:00Z"
    }
  }
]
```

---

### constraints (array, required)

#### Definition
Array of constraints that apply to this output. These constraints ensure safety and prevent autonomous actions.

#### Required Constraints
- `"READ_ONLY"` - Output is read-only, no side effects
- `"NO_PUBLISH"` - Output cannot be published without approval
- `"HUMAN_REVIEW_REQUIRED"` - Output requires human review

#### Optional Constraints
- `"NO_AUTOPUBLISH"` - No automatic publishing allowed
- `"APPROVAL_REQUIRED"` - Explicit approval required
- `"HIGH_CONFIDENCE_ONLY"` - Only high-confidence outputs

#### Examples
```json
"constraints": [
  "READ_ONLY",
  "NO_PUBLISH",
  "HUMAN_REVIEW_REQUIRED"
]
```

---

## Output Validation

### Required Fields
- `loop` (string, required)
- `timestamp` (string, required, ISO-8601 format)
- `confidence` (number, required, 0.0-1.0)
- `signals` (array, required)
- `ideas` (array, required)
- `risks` (array, required)
- `recommended_actions` (array, required)
- `constraints` (array, required)

### Field Validation
- `loop` must be a valid loop identifier
- `timestamp` must be valid ISO-8601 format
- `confidence` must be between 0.0 and 1.0
- `signals` must be an array (can be empty)
- `ideas` must be an array (can be empty)
- `risks` must be an array (can be empty)
- `recommended_actions` must be an array (can be empty)
- `constraints` must include required constraints

---

## Example Outputs

### Example 1: Trend Scan Output

```json
{
  "loop": "trend_scan",
  "timestamp": "2026-01-25T12:00:00Z",
  "confidence": 0.85,
  "signals": [
    {
      "type": "trend_signal",
      "signal_id": "trend-001",
      "description": "Action-comedy genre gaining popularity",
      "confidence": 0.85,
      "priority": "high",
      "metadata": {
        "trend_strength": 0.75,
        "trend_drivers": ["Recent hit movies", "Audience preference shift"],
        "trend_trajectory": "Continuing upward trend"
      }
    }
  ],
  "ideas": [],
  "risks": [],
  "recommended_actions": [
    {
      "type": "review_action",
      "action_id": "action-001",
      "description": "Review emerging trend signal for action-comedy genre",
      "priority": "high",
      "confidence": 0.80,
      "metadata": {
        "related_signal": "trend-001"
      }
    }
  ],
  "constraints": [
    "READ_ONLY",
    "NO_PUBLISH",
    "HUMAN_REVIEW_REQUIRED"
  ]
}
```

### Example 2: Opportunity Detection Output

```json
{
  "loop": "opportunity_detection",
  "timestamp": "2026-01-25T12:00:00Z",
  "confidence": 0.80,
  "signals": [],
  "ideas": [
    {
      "type": "editorial_idea",
      "idea_id": "idea-001",
      "title": "Trend Analysis: Action-Comedy Genre",
      "description": "Write article about emerging action-comedy trend",
      "confidence": 0.80,
      "priority": "medium",
      "metadata": {
        "target_audience": "movie enthusiasts",
        "estimated_read_time": "5 minutes"
      }
    }
  ],
  "risks": [],
  "recommended_actions": [
    {
      "type": "implementation_action",
      "action_id": "action-001",
      "description": "Consider writing editorial article about action-comedy trend",
      "priority": "medium",
      "confidence": 0.80,
      "metadata": {
        "related_idea": "idea-001"
      }
    }
  ],
  "constraints": [
    "READ_ONLY",
    "NO_PUBLISH",
    "HUMAN_REVIEW_REQUIRED"
  ]
}
```

---

## Contract Enforcement

### Enforcement Mechanisms

1. **Schema Validation**
   - All outputs must match this schema
   - Validation occurs before output is saved
   - Invalid outputs are rejected

2. **Required Constraints**
   - All outputs must include required constraints
   - Constraints are enforced by runner
   - Constraint violations are logged

3. **Confidence Validation**
   - Confidence scores must be valid (0.0-1.0)
   - Confidence calculation follows confidence model
   - Invalid confidence scores are rejected

---

## Contract Violations

### Violation Types

1. **Schema Violations**
   - Missing required fields
   - Invalid field types
   - Invalid field values

2. **Constraint Violations**
   - Missing required constraints
   - Invalid constraint values
   - Constraint conflicts

3. **Confidence Violations**
   - Invalid confidence scores
   - Confidence outside valid range
   - Confidence calculation errors

### Violation Consequences

1. **Reject Output**: Invalid outputs are rejected
2. **Log Violation**: Log all violations for audit
3. **Alert Admin**: Alert administrators of violations
4. **Review Process**: Review process to prevent future violations

---

## Contract Maintenance

### Contract Updates

- Contract updates require explicit approval
- Contract changes must be documented
- Contract changes must be tested
- Contract changes must be reviewed

### Contract Monitoring

- Monitor for contract violations
- Track contract compliance
- Generate contract compliance reports
- Review contract effectiveness

---

## References

- **Confidence Model**: `clawdbot/scoring/confidence_model.md`
- **Handoff Format**: `.cursor/governance/handoff_format.md`
- **Policy Constraints**: `clawdbot/policies/`